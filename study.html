<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üéß H·ªçc c√πng anh</title>
  <link rel="stylesheet" href=".style//style.css" />
  <link rel="stylesheet" href=".style//study.css" />
  <style>
    :root {
      --study-bg: linear-gradient(180deg, #fff0f5 0%, #ffe0eb 100%);
      --break-bg: linear-gradient(180deg, #e5e0ff 0%, #d0bfff 100%);
      --long-bg: linear-gradient(180deg, #e0f7fa 0%, #b2ebf2 100%);
    }
    body {
      background: var(--study-bg);
      font-family: "Segoe UI", sans-serif;
      text-align: center;
      color: #d63384;
      transition: background 1.5s ease;
      overflow-y: auto; /* was: overflow: hidden; */
    }
    h2 {
      margin-top: 40px;
      font-size: 2rem;
      animation: fadeIn 1s ease;
    }
    #dashboard {
      background: rgba(255,255,255,0.7);
      border-radius: 15px;
      box-shadow: 0 0 10px rgba(255,182,193,0.6);
      width: 320px;
      margin: 30px auto;
      padding: 20px;
      backdrop-filter: blur(5px);
      animation: fadeIn 1.2s ease;
    }
    #timer {
      font-size: 2.5rem;
      font-weight: bold;
      color: #ff5c8a;
      margin-bottom: 10px;
    }
    #quote {
      font-size: 1.1rem;
      color: #ff77a5;
      min-height: 50px;
    }
    #info {
      font-size: 1rem;
      color: #b83b78;
      margin: 10px 0;
    }
    button {
      background: #ff9fbf;
      border: none;
      border-radius: 10px;
      padding: 8px 16px;
      color: white;
      font-size: 15px;
      margin: 5px;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background: #ff77a5;
      transform: scale(1.05);
    }
    .heart {
      position: absolute;
      bottom: -20px;
      color: #ff7aa2;
      font-size: 20px;
      animation: floatUp 6s linear infinite;
      opacity: 0.8;
    }
    @keyframes floatUp {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(-100vh) scale(0.6); opacity: 0; }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 240, 245, 0.9);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 10;
      animation: fadeIn 1s ease;
      text-align: center;
      color: #d63384;
    }

    /* üéß Mini lofi playlist panel */
    #lofiPanel{
      position:fixed; left:16px; bottom:16px; width:230px; z-index:12;
      background:rgba(255,255,255,0.9); border:1px solid #ffd6e8; border-radius:12px;
      box-shadow:0 8px 24px rgba(255,92,138,.18); padding:10px;
      backdrop-filter: blur(6px);
    }
    #lofiPanel .lofi-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;color:#d63384;font-weight:700}
    #lofiPanel ul{list-style:none;margin:0;padding:0;max-height:150px;overflow:auto}
    #lofiPanel li{display:flex;gap:6px;align-items:center;padding:6px 8px;border-radius:8px;cursor:pointer;color:#8a4760}
    #lofiPanel li:hover{background:#ffe4ec}
    #lofiPanel li.playing{background:#ffebf3;color:#d63384;font-weight:700}
    #lofiPanel .lofi-controls{display:flex;gap:6px;justify-content:center;margin-top:8px}
    #lofiPanel .lofi-controls button{background:#ff9fbf;border:none;border-radius:8px;padding:6px 10px;color:#fff;cursor:pointer}
    #lofiPanel .lofi-controls button:hover{filter:brightness(1.05)}
    #lofiPanel .toggle{display:flex;align-items:center;gap:6px;font-weight:600;color:#8a4760}

    /* üéß Mini playlists */
    #studyPanel{
      position:fixed; left:16px; bottom:210px; width:230px; z-index:12;
      background:rgba(255,255,255,0.9); border:1px solid #ffd6e8; border-radius:12px;
      box-shadow:0 8px 24px rgba(255,92,138,.18); padding:10px; backdrop-filter: blur(6px);
    }
    #studyPanel .lofi-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;color:#d63384;font-weight:700}
    #studyPanel ul{list-style:none;margin:0;padding:0;max-height:150px;overflow:auto}
    #studyPanel li{display:flex;gap:6px;align-items:center;padding:6px 8px;border-radius:8px;cursor:pointer;color:#8a4760}
    #studyPanel li:hover{background:#ffe4ec}
    #studyPanel li.playing{background:#ffebf3;color:#d63384;font-weight:700}
    #studyPanel .lofi-controls{display:flex;gap:6px;justify-content:center;margin-top:8px}
    #studyPanel .lofi-controls button{background:#ff9fbf;border:none;border-radius:8px;padding:6px 10px;color:#fff;cursor:pointer}
    #studyPanel .lofi-controls button:hover{filter:brightness(1.05)}
    #studyPanel .toggle{display:flex;align-items:center;gap:6px;font-weight:600;color:#8a4760}

    /* === Music Dock + Toggle button (override layout) === */
    #btnTogglePlaylist{
      position: fixed; left: 16px; bottom: 16px; z-index: 13;
      background:#ff9fbf; color:#fff; border:none; border-radius:999px;
      padding:8px 14px; box-shadow:0 6px 16px rgba(255,92,138,.18); cursor:pointer;
    }
    #btnTogglePlaylist:hover{ filter:brightness(1.05) }

    #musicDock{
      position: fixed; left: 16px; bottom: 60px; z-index: 12;
      display: none; /* m·∫∑c ƒë·ªãnh ·∫©n */
      gap: 12px; align-items: flex-start;
      display: none; /* ƒë·∫£m b·∫£o ·∫©n l√∫c ƒë·∫ßu */
    }

    /* Khi ·ªü trong dock, 2 panel ƒë·ª©ng c·∫°nh nhau (kh√¥ng c√≤n fixed) */
    #musicDock #studyPanel,
    #musicDock #lofiPanel{
      position: static; left:auto; bottom:auto;
      width: 260px;
    }

    /* ƒê·ªÉ t∆∞∆°ng th√≠ch rule c≈© (ƒëang fixed), √©p width l·∫°i trong dock */
    #musicDock #studyPanel .lofi-controls button,
    #musicDock #lofiPanel .lofi-controls button{ white-space: nowrap }

    @media (max-width: 680px){
      #musicDock{ flex-direction: column; right: 16px; }
    }

    /* Thanh √¢m l∆∞·ª£ng trong dock (vertical) */
    #volumeRow{
      display:flex; flex-direction: column; align-items:center; justify-content:center; gap:8px;
      background:rgba(255,255,255,0.9); border:1px solid #ffd6e8; border-radius:12px;
      padding:8px 10px; box-shadow:0 8px 24px rgba(255,92,138,.08);
      /* ƒë·ª©ng d·ªçc, kh√¥ng chi·∫øm c·∫£ h√†ng */
      flex: 0 0 auto; width: 56px; height: 220px;
    }
    #volumeRow label{font-weight:700;color:#8a4760;white-space:nowrap; font-size:12px}
    #musicVolume{
      accent-color:#ff9fbf;
      /* fallback: xoay ngang th√†nh d·ªçc */
      transform: rotate(-90deg);
      width: 170px; height: 28px;
    }
    /* WebKit: slider d·ªçc g·ªëc */
    @supports (-webkit-appearance: slider-vertical) {
      #musicVolume{
        transform: none;
        -webkit-appearance: slider-vertical;
        appearance: slider-vertical;
        width: 28px; height: 170px;
      }
    }
    #musicVolumeVal{ min-width:auto; text-align:center; color:#d63384; font-weight:700; font-size:12px }
    @media (max-width: 680px){
      #volumeRow{ height: 180px; }
      #musicVolume{ width: 130px; }
    }
  </style>
</head>
<body>
  <h2>üéß H·ªçc c√πng anh n√†o, c√¥ g√°i chƒÉm ch·ªâ üíï</h2>

  <!-- New layout wrapper -->
  <div id="appWrap">
    <div id="dashboard">
      <div id="modeBar" class="modeBar" role="tablist" aria-label="Ch·∫ø ƒë·ªô">
        <button id="modePomodoro" class="modeBtn active" role="tab" aria-selected="true">Pomodoro</button>
        <button id="modeShort" class="modeBtn" role="tab" aria-selected="false">Ngh·ªâ ng·∫Øn 5‚Äô</button>
        <button id="modeLong" class="modeBtn" role="tab" aria-selected="false">Ngh·ªâ d√†i 15‚Äô-30‚Äô </button>
      </div>
      <div id="timer">25:00</div>
      <div id="info">üçÖ Pomodoro: <span id="pomoCount">0</span></div>
      <div id="progress" class="hearts" aria-label="Ti·∫øn ƒë·ªô 4 Pomodoro">
        <span class="heart" data-i="1">‚ù§</span>
        <span class="heart" data-i="2">‚ù§</span>
        <span class="heart" data-i="3">‚ù§</span>
        <span class="heart" data-i="4">‚ù§</span>
      </div>
      <div id="quote">Nh·∫•n ‚ÄúB·∫Øt ƒë·∫ßu h·ªçc‚Äù ƒë·ªÉ c√πng anh h·ªçc nh√© üå∏</div>
      <div>
        <button id="startBtn">‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu</button>
        <button id="resetBtn">üîÅ Reset</button>
        <button id="skipBtn">‚è≠Ô∏è B·ªè qua</button>
      </div>
    </div>

    <!-- New right-side panel -->
    <div class="sidePanel">
      <h3>üìä Th·ªëng k√™ h√¥m nay c·ªßa ng∆∞·ªùi iu ƒê√¨nh Nam</h3>
      <div id="stats">
        <div>T·ªïng ph√∫t h·ªçc:</div><div><span id="statMins">0</span> ph√∫t</div>
        <div>Pomodoro ƒë√£ ho√†n th√†nh:</div><div><span id="statPomos">0</span></div>
        <div>Nhi·ªám v·ª• ƒë√£ xong:</div><div><span id="statTasks">0</span></div>
      </div>
      <!-- TH√äM: n√∫t reset th·ªëng k√™ -->
      <div style="margin:8px 0;">
        <button id="btnResetStats">üßπ Reset th·ªëng k√™</button>
      </div>

      <h3>üìù K·∫ø ho·∫°ch</h3>
      <!-- TH√äM: n√∫t xo√° t·∫•t c·∫£ nhi·ªám v·ª• -->
      <div style="margin:8px 0;">
        <button id="btnResetTasks">üóëÔ∏è Xo√° t·∫•t c·∫£ nhi·ªám v·ª•</button>
      </div>
      <form id="taskForm">
        <input id="taskTitle" type="text" placeholder="T√™n nhi·ªám v·ª•" required />
        <input id="taskMins" type="number" min="1" step="1" placeholder=" S·ªë ph√∫t" required />
        <button type="submit">Th√™m</button>
      </form>
      <ul id="taskList"></ul>
    </div>
  </div>

  <a href="index.html"><button>‚¨ÖÔ∏è Quay l·∫°i trang ch√≠nh</button></a>

  <!-- N√∫t b·∫≠t/t·∫Øt danh s√°ch nh·∫°c -->
  <button id="btnTogglePlaylist">üéµ Danh s√°ch nh·∫°c</button>

  <!-- Dock ch·ª©a 2 playlist c·∫°nh nhau -->
  <div id="musicDock">
    <!-- üéß Mini study instrumental playlist -->
    <div id="studyPanel" aria-label="Playlist nh·∫°c h·ªçc b√†i kh√¥ng l·ªùi">
      <div class="lofi-head">
        <span>üéß Nh·∫°c h·ªçc b√†i kh√¥ng l·ªùi</span>
        <label class="toggle">
          <input type="checkbox" id="studyToggle" />
          <span>T·∫Øt / B·∫≠t</span>
        </label>
      </div>
      <ul id="studyList"></ul>
      <div class="lofi-controls">
        <button id="studyPrev" title="B√†i tr∆∞·ªõc">‚èÆÔ∏è</button>
        <button id="studyPlayPause" title="Ph√°t/T·∫°m d·ª´ng">‚èØÔ∏è</button>
        <button id="studyNext" title="B√†i sau">‚è≠Ô∏è</button>
      </div>
    </div>

    <!-- üéß Mini lofi playlist -->
    <div id="lofiPanel" aria-label="Playlist lofi">
      <div class="lofi-head">
        <span>üéß List nh·∫°c iu th∆∞∆°ng </span>
        <label class="toggle">
          <input type="checkbox" id="lofiToggle" />
          <span>T·∫Øt / B·∫≠t</span>
        </label>
      </div>
      <ul id="lofiList"></ul>
      <div class="lofi-controls">
        <button id="lofiPrev" title="B√†i tr∆∞·ªõc">‚èÆÔ∏è</button>
        <button id="lofiPlayPause" title="Ph√°t/T·∫°m d·ª´ng">‚èØÔ∏è</button>
        <button id="lofiNext" title="B√†i sau">‚è≠Ô∏è</button>
      </div>
    </div>

    <!-- √Çm l∆∞·ª£ng chung -->
    <div id="volumeRow">
      <label for="musicVolume">üîä √Çm l∆∞·ª£ng</label>
      <input id="musicVolume" type="range" min="0" max="100" step="1" />
      <span id="musicVolumeVal">80%</span>
    </div>
  </div>

  <audio id="lofiAudio" preload="metadata"></audio>

  <!-- Nh·∫°c -->
  <audio id="musicStudy" src="https://audio.jukehost.co.uk/IxemVj7ywy6KKyY0ej78OvdoO16yusgB" preload="auto" loop></audio>
  <audio id="musicBreak" src="https://audio.jukehost.co.uk/IxemVj7ywy6KKyY0ej78OvdoO16yusgB" preload="auto" loop></audio>
  <audio id="alertSound" src="alert.mp3" preload="auto" loop></audio>

  <!-- Overlay khi h·∫øt gi·ªù -->
  <div id="overlay">
    <h2 id="overlayTitle">üå∏ Gi·ªèi l·∫Øm, c√¥ g√°i b√© nh·ªè c·ªßa anh üíñ</h2>
    <p id="overlayQuote"></p>
    <div>
      <button id="nextBtn">Ti·∫øp t·ª•c</button>
      <!-- N√∫t nh·∫≠n qu√† s·∫Ω hi·ªÉn th·ªã khi ƒë·∫øn th∆∞·ªüng (sau 4 Pomodoro) -->
      <button id="claimBtn" style="display:none">üéÅ Nh·∫≠n qu√†</button>
    </div>
  </div>

  <!-- Inline script replacing external file to avoid conflicts -->
  <script>
  (function(){
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    // Elements
    const timerEl = $("#timer");
    const pomoCountEl = $("#pomoCount");
    const quoteEl = $("#quote");
    const overlay = $("#overlay");
    const overlayTitle = $("#overlayTitle");
    const overlayQuote = $("#overlayQuote");
    const nextBtn = $("#nextBtn");
    const claimBtn = $("#claimBtn");
    const startBtn = $("#startBtn");
    const resetBtn = $("#resetBtn");
    const skipBtn = $("#skipBtn");
    const modeBtns = {
      pomo: $("#modePomodoro"),
      short: $("#modeShort"),
      long: $("#modeLong")
    };
    const statMins = $("#statMins");
    const statPomos = $("#statPomos");
    const statTasks = $("#statTasks");
    const taskForm = $("#taskForm");
    const taskTitle = $("#taskTitle");
    const taskMins = $("#taskMins");
    const taskList = $("#taskList");
    const studyMusic = $("#musicStudy");
    const breakMusic = $("#musicBreak");
    // TH√äM: alert audio
    const alertSound = $("#alertSound");
    // TH√äM:
    const btnResetStats = $("#btnResetStats");
    const lofiAudio = $("#lofiAudio");
    // Volume elements
    const volumeSlider = $("#musicVolume");
    const volumeLabel  = $("#musicVolumeVal");

    // NEW: dock toggle
    const musicDock = $("#musicDock");
    const btnTogglePlaylist = $("#btnTogglePlaylist");

    /* üéß TWO PLAYLISTS: STUDY (instrumental) + LOVE (lofi) */
    const STUDY_TRACKS = [
      { title: "Nh·∫°c piano kh√¥ng l·ªùi", src: "https://audio.jukehost.co.uk/IxemVj7ywy6KKyY0ej78OvdoO16yusgB" }
    ];
    const LOVE_TRACKS = [
      { title: "Lofi 1", src: "2.mp3" },
      { title: "Lofi 2", src: "1.mp3" },
      { title: "Lofi 3", src: "6.mp3" },
      { title: "Lofi 4", src: "4.mp3" },
      { title: "Lofi 5", src: "3.mp3" },
      { title: "Lofi 6", src: "style/IxkUNOlUqqWjHD9b.mp3" }
    ];

    // Volume state + helpers
    function loadVolume(){
      try {
        const v = parseFloat(localStorage.getItem("music.volume"));
        return isNaN(v) ? 0.8 : Math.min(Math.max(v,0),1);
      } catch { return 0.8; }
    }
    function saveVolume(v){ localStorage.setItem("music.volume", String(v)); }
    function applyVolume(v){
      try {
        lofiAudio.volume = v;
        studyMusic.volume = v;
        breakMusic.volume = v;
      } catch {}
    }
    let musicVol = loadVolume();
    // init slider UI
    if (volumeSlider && volumeLabel){
      volumeSlider.value = Math.round(musicVol * 100);
      volumeLabel.textContent = `${Math.round(musicVol * 100)}%`;
      applyVolume(musicVol);
      volumeSlider.addEventListener("input", () => {
        musicVol = Math.max(0, Math.min(1, parseInt(volumeSlider.value,10)/100));
        applyVolume(musicVol);
        saveVolume(musicVol);
        volumeLabel.textContent = `${Math.round(musicVol * 100)}%`;
      });
    }

    // State for players
    let lofiEnabled = loadLofiEnabled();
    let activePlaylist = loadActivePlaylist(); // 'study' | 'love'
    if (activePlaylist !== 'study' && activePlaylist !== 'love') activePlaylist = 'study';

    let studyIndex = loadIndex("study.index", STUDY_TRACKS.length);
    let loveIndex  = loadIndex("love.index", LOVE_TRACKS.length);

    // === Dock visibility state ===
    let dockVisible = loadDockVisible();
    function loadDockVisible(){ try { return localStorage.getItem("musicDock.visible")==="1"; } catch { return false; } }
    function saveDockVisible(v){ localStorage.setItem("musicDock.visible", v ? "1" : "0"); }
    function updateDockUI(){
      musicDock.style.display = dockVisible ? "flex" : "none";
      btnTogglePlaylist.textContent = dockVisible ? "·∫®n danh s√°ch nh·∫°c" : "üéµ Danh s√°ch nh·∫°c";
    }
    btnTogglePlaylist.addEventListener("click", () => {
      dockVisible = !dockVisible;
      saveDockVisible(dockVisible);
      updateDockUI();
    });

    function loadLofiEnabled(){ try { return localStorage.getItem("lofi.enabled")==="1"; } catch { return false; } }
    function saveLofiEnabled(v){ localStorage.setItem("lofi.enabled", v ? "1" : "0"); }
    function loadActivePlaylist(){ try { return localStorage.getItem("lofi.active") || "study"; } catch { return "study"; } }
    function saveActivePlaylist(){ localStorage.setItem("lofi.active", activePlaylist); }
    function loadIndex(key, max){
      try {
        const n = parseInt(localStorage.getItem(key)||"0",10);
        return isNaN(n) ? 0 : Math.min(Math.max(n,0), max-1);
      } catch { return 0; }
    }
    function saveIndex(key, val){ localStorage.setItem(key, String(val)); }

    function currentTrack(){
      return activePlaylist === "study" ? STUDY_TRACKS[studyIndex] : LOVE_TRACKS[loveIndex];
    }

    function renderStudyList(){
      studyList.innerHTML = STUDY_TRACKS.map((t,i) => `
        <li data-i="${i}" class="${activePlaylist==='study' && i===studyIndex && !lofiAudio.paused && !lofiAudio.ended ? 'playing':''}">
          ${t.title}
        </li>
      `).join("");
      $$("#studyList li").forEach(li => {
        li.addEventListener("click", () => {
          activePlaylist = "study"; saveActivePlaylist();
          studyIndex = parseInt(li.dataset.i,10); saveIndex("study.index", studyIndex);
          setLofiEnabled(true);
          playCurrent(true);
        });
      });
      updatePlayerUI();
    }
    function renderLoveList(){
      lofiList.innerHTML = LOVE_TRACKS.map((t,i) => `
        <li data-i="${i}" class="${activePlaylist==='love' && i===loveIndex && !lofiAudio.paused && !lofiAudio.ended ? 'playing':''}">
          ${t.title}
        </li>
      `).join("");
      $$("#lofiList li").forEach(li => {
        li.addEventListener("click", () => {
          activePlaylist = "love"; saveActivePlaylist();
          loveIndex = parseInt(li.dataset.i,10); saveIndex("love.index", loveIndex);
          setLofiEnabled(true);
          playCurrent(true);
        });
      });
      updatePlayerUI();
    }

    function updatePlayerUI(){
      // highlight playing item
      $$("#studyList li").forEach((li,i) => {
        li.classList.toggle("playing", activePlaylist==='study' && i===studyIndex && !lofiAudio.paused && !lofiAudio.ended);
      });
      $$("#lofiList li").forEach((li,i) => {
        li.classList.toggle("playing", activePlaylist==='love' && i===loveIndex && !lofiAudio.paused && !lofiAudio.ended);
      });
      // buttons + toggles
      const paused = lofiAudio.paused || lofiAudio.ended;
      studyPlayPause.textContent = (activePlaylist==='study' && !paused) ? "‚è∏Ô∏è" : "‚ñ∂Ô∏è";
      lofiPlayPause.textContent = (activePlaylist==='love' && !paused) ? "‚è∏Ô∏è" : "‚ñ∂Ô∏è";
      // only one toggle ON when enabled
      studyToggle.checked = lofiEnabled && activePlaylist==='study';
      lofiToggle.checked  = lofiEnabled && activePlaylist==='love';
    }

    function ensureSrc(){
      const { src } = currentTrack();
      if (!lofiAudio.src || !lofiAudio.src.endsWith(src)) {
        lofiAudio.src = src;
      }
    }
    function playCurrent(forceChange){
      if (forceChange) { lofiAudio.src = currentTrack().src; }
      else ensureSrc();
      lofiAudio.play().catch(()=>{ /* ignore */ });
      updatePlayerUI();
    }
    function pausePlayer(){
      try { lofiAudio.pause(); } catch {}
      updatePlayerUI();
    }
    function setLofiEnabled(flag){
      lofiEnabled = flag; saveLofiEnabled(flag);
      if (!flag) pausePlayer();
      else playCurrent(false);
      updatePlayerUI();
    }

    function nextStudy(){
      studyIndex = (studyIndex + 1) % STUDY_TRACKS.length;
      saveIndex("study.index", studyIndex);
      if (activePlaylist==='study') playCurrent(true);
      renderStudyList();
    }
    function prevStudy(){
      studyIndex = (studyIndex - 1 + STUDY_TRACKS.length) % STUDY_TRACKS.length;
      saveIndex("study.index", studyIndex);
      if (activePlaylist==='study') playCurrent(true);
      renderStudyList();
    }
    function nextLove(){
      loveIndex = (loveIndex + 1) % LOVE_TRACKS.length;
      saveIndex("love.index", loveIndex);
      if (activePlaylist==='love') playCurrent(true);
      renderLoveList();
    }
    function prevLove(){
      loveIndex = (loveIndex - 1 + LOVE_TRACKS.length) % LOVE_TRACKS.length;
      saveIndex("love.index", loveIndex);
      if (activePlaylist==='love') playCurrent(true);
      renderLoveList();
    }

    // Wire controls
    studyToggle.addEventListener("change", () => {
      if (studyToggle.checked){
        activePlaylist = "study"; saveActivePlaylist();
        setLofiEnabled(true);
      } else {
        setLofiEnabled(false);
      }
    });
    lofiToggle.addEventListener("change", () => {
      if (lofiToggle.checked){
        activePlaylist = "love"; saveActivePlaylist();
        setLofiEnabled(true);
      } else {
        setLofiEnabled(false);
      }
    });

    studyPlayPause.addEventListener("click", () => {
      if (activePlaylist!=='study' || lofiAudio.paused) { activePlaylist='study'; saveActivePlaylist(); setLofiEnabled(true); playCurrent(true); }
      else pausePlayer();
    });
    lofiPlayPause.addEventListener("click", () => {
      if (activePlaylist!=='love' || lofiAudio.paused) { activePlaylist='love'; saveActivePlaylist(); setLofiEnabled(true); playCurrent(true); }
      else pausePlayer();
    });
    studyPrev.addEventListener("click", () => { activePlaylist='study'; saveActivePlaylist(); prevStudy(); });
    studyNext.addEventListener("click", () => { activePlaylist='study'; saveActivePlaylist(); nextStudy(); });
    lofiPrev.addEventListener("click", () => { activePlaylist='love'; saveActivePlaylist(); prevLove(); });
    lofiNext.addEventListener("click", () => { activePlaylist='love'; saveActivePlaylist(); nextLove(); });

    // when a song ends -> loop inside active playlist only
    lofiAudio.addEventListener("ended", () => {
      if (activePlaylist==='study') nextStudy();
      else nextLove();
    });

    // initial render
    renderStudyList();
    renderLoveList();
    updateDockUI(); // initialize hidden-by-default UI
    applyVolume(musicVol); // ensure volume applied at start

    // Config
    const MODES = { pomo: 25*60, short: 5*60, long: 30*60 };
    const MODE_BG = { pomo: "var(--study-bg)", short: "var(--break-bg)", long: "var(--long-bg)" };
    const quotesStudy = [
      "Anh ƒëang h·ªçc c√πng em ƒë√≥, c·ªë l√™n nha Pthuyüí™",
      "M·ªói ph√∫t h·ªçc l√† m·ªôt b∆∞·ªõc g·∫ßn h∆°n t·ªõi th√†nh c√¥ng c√πng anh! üíñ",
      "Em y√™u chƒÉm gh√™, x·ª©ng ƒë√°ng c√≥ ƒë∆∞·ª£c anhh hihiüíï",
      "Anh tin em l√†m ƒë∆∞·ª£c, anh v√† Pthuy c√πng nhau t·∫≠p trung nh√© üå∏",
      "H·ªçc h√¥m nay ƒë·ªÉ mai m√¨nh c√πng nhau r·ª±c r·ª°, h·∫°nh ph√∫c n√†o em iu ‚ú®",
      "Em gi·ªèi l·∫Øm, anh t·ª± h√†o v·ªÅ em l·∫Øm Pthuy ü•∞",
      "T·ª´ng ch√∫t m·ªôt c≈©ng l√† ti·∫øn b·ªô, em nh√© üå±",
      "Anh ·ªü ƒë√¢y c√πng em, c√¥ g√°i chƒÉm ch·ªâ c·ªßa anh üíù"
    ];
    const quotesShortBreak = [
      "üíú Ngh·ªâ 5 ph√∫t nh·∫π nh√†ng nha em y√™u üå∏",
      "U·ªëng n∆∞·ªõc ƒëi em, v·ª´a u·ªëng v·ª´a nghƒ© ƒë·∫øn anhh ...  ‚òïüíï",
      "Anh ch·ªù em 5 ph√∫t thui ƒë√≥, ngh·ªâ t√≠ r·ªìi m√¨nh h·ªçc ti·∫øp ·∫°a üòÜ",
      "H√≠t th·ªü s√¢u, th·∫£ l·ªèng vai n√†o c√¥ g√°i c·ªßa anh üòåüíñ",
      "Gi√£n c∆° nh·∫π m·ªôt ch√∫t nha, ƒë·ª´ng ng·ªìi l√¢u qu√° h·ªã üßò‚Äç‚ôÄÔ∏è",
      "5 ph√∫t ng·∫Øn ng·ªßi, ngh·ªâ xong quay l·∫°i h·ªçc li·ªÅn nha üå∑",
      "Nh·∫Øm m·∫Øt ngh·ªâ t√≠ cho m·∫Øt s√°ng nh√©, g√°i xinh üëÄ‚ú®"
    ];
    const quotesLongBreak = [
      "üíô Ngh·ªâ d√†i 15-30 ph√∫t thoaiii, em x·ª©ng ƒë√°ng l·∫Øm! üéâ",
      "Th∆∞ gi√£n s√¢u ƒëi em, l·∫•y l·∫°i nƒÉng l∆∞·ª£ng n√†o üå∑üíï",
      "Anh t·ª± h√†o v·ªÅ em l·∫Øm, c√¥ g√°i nh·ªè ki√™n tr√¨ üíñ",
      "Th·ªùi gian n√†y l√† c·ªßa em, em l√†m g√¨ c≈©ng ƒë∆∞·ª£c nha ü•∞",
      "ƒêi d·∫°o quanh nh√†, v·∫≠n ƒë·ªông ch√∫t ƒëi em uii üö∂‚Äç‚ôÄÔ∏èüí´",
      "Anh nghƒ© em n√™n n·∫±m ngh·ªâ x√≠uuuuu üò¥üíù",
      "Nh·∫Øn tin cho anh n√≥i chuy·ªán th·ªùi gian n√†y c≈©ng ƒë∆∞·ª£c nha üìûüíï",
      "Nghe nh·∫°c th∆∞ gi√£n, ƒë·ªÉ ƒë·∫ßu √≥c ngh·ªâ ng∆°i em b√© nh√© üéµ‚ú®"
    ];

    // Reward messages (used when reaching 4 Pomodoro)
    const rewardMessages = [
      "üéâ √î mai g√≥t! Th·∫ø l√† Pthuy ƒë√£ v∆∞·ª£t qua 4 pomodoro. Nh·∫≠n qu√† nh·ªè tinh th·∫ßn t·ª´ anh nh√© üíù",
      "üåü 4 Pomodoro ƒë√£ ho√†n th√†nh! em qu√° chƒÉm ch·ªâ v√† xinh ƒë·∫πp ü•∞",
      "üéÅ Anh chu·∫©n b·ªã m√≥n qu√† tinh th·∫ßn nho nh·ªè cho em ‚Äî nh·∫≠n ngay ƒëi c√¥ g√°i c·ªßa anh üíï",
      "‚ú® Uwaooooo ,Ch·∫Øc em b√© ƒë√£ si√™u c·ªë g·∫Øng, nh·∫≠n qu√† n√†y t·ª´ anh nh√© ·∫° üíñ"
    ];

    // State
    let mode = "pomo";
    let timeLeft = MODES[mode];
    let timerId = null;
    let running = false;
    let lastTick = 0;
    let activeTaskId = null;
    let stats = loadStats();
    let tasks = loadTasks();
    let pendingNextMode = null;

    // Init
    applyModeUI();
    setTimeLeft(MODES.pomo);
    updateTimerUI();
    updateStatsUI();
    renderTasks();
    updateHearts();
    quoteEl.textContent = "Nh·∫•n ‚ÄúB·∫Øt ƒë·∫ßu h·ªçc‚Äù ƒë·ªÉ c√πng anh h·ªçc nh√© üå∏";
    claimBtn.style.display = "none";

    // Events
    modeBtns.pomo.addEventListener("click", () => switchMode("pomo"));
    modeBtns.short.addEventListener("click", () => switchMode("short"));
    modeBtns.long.addEventListener("click", () => switchMode("long"));

    startBtn.addEventListener("click", toggleStart);
    resetBtn.addEventListener("click", resetTimer);
    skipBtn.addEventListener("click", () => endSession(true));

    // TH√äM: reset th·ªëng k√™
    btnResetStats.addEventListener("click", () => {
      if (!confirm("Reset to√†n b·ªô th·ªëng k√™?")) return;
      stats.totalStudySec = 0;
      stats.totalPomos = 0;
      saveStats();
      updateStatsUI();
      updateHearts();
    });

    nextBtn.addEventListener("click", () => {
      try { alertSound.pause(); alertSound.currentTime = 0; } catch {}
      overlay.style.display = "none";
      if (pendingNextMode) switchMode(pendingNextMode);
      startTimer();
    });

    // Claim button opens reward page (only when shown)
    claimBtn.addEventListener("click", () => {
      try { alertSound.pause(); alertSound.currentTime = 0; } catch {}
      // Optionally hide overlay before navigating
      overlay.style.display = "none";
      // Navigate to reward page (user will be redirected only after clicking)
      window.location.href = "monqua.html";
    });

    taskForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const t = taskTitle.value.trim();
      const m = parseInt(taskMins.value, 10);
      if (!t || isNaN(m) || m <= 0) return;
      tasks.push({ id: cryptoId(), title: t, minsTotal: m, minsRemaining: m, done: false });
      saveTasks();
      renderTasks();
      taskForm.reset();
    });

    // TH√äM: x·ª≠ l√Ω reset th·ªëng k√™
    $("#btnResetStats").addEventListener("click", () => {
      if (!confirm("Reset to√†n b·ªô th·ªëng k√™?")) return;
      stats = { totalStudySec: 0, totalPomos: 0 };
      saveStats();
      updateStatsUI();
      updateHearts();
    });

    // TH√äM: x·ª≠ l√Ω xo√° t·∫•t c·∫£ nhi·ªám v·ª•
    $("#btnResetTasks").addEventListener("click", () => {
      if (!confirm("Xo√° t·∫•t c·∫£ nhi·ªám v·ª•?")) return;
      tasks = [];
      activeTaskId = null;
      saveTasks();
      saveActiveTask();
      renderTasks();
    });

    // TH√äM: ph√°t chu√¥ng b√°o
    function playAlert(){
      try {
        studyMusic.pause(); breakMusic.pause();
        pausePlayer?.();
        alertSound.currentTime = 0;
        alertSound.volume = 1;
        alertSound.play().catch(() => {
          // fallback n·∫øu b·ªã ch·∫∑n autoplay
          document.body.addEventListener("click", () => {
            alertSound.currentTime = 0; alertSound.play().catch(()=>{});
          }, { once: true });
        });
      } catch {}
    }

    function endSession(skipped){
      pauseTimer();
      const endedMode = mode;

      // ph√°t chu√¥ng
      playAlert();

      if (endedMode === "pomo" && !skipped){
        stats.totalPomos += 1;
        saveStats();
        updateHearts();
      }
      updateStatsUI();

      overlay.style.display = "flex";
      claimBtn.style.display = "none"; // default hide
      if (endedMode === "pomo"){
        overlayTitle.textContent = "üå∏ Gi·ªèi l·∫Øm, c√¥ g√°i c·ªßa anh üíñ";
        const isLong = (!skipped && stats.totalPomos % 4 === 0);
        pendingNextMode = isLong ? "long" : "short";
        overlayQuote.textContent = isLong ? randomOf(quotesLongBreak) : randomOf(quotesShortBreak);

        // N·∫øu l√† Pomodoro th·ª© 4 (m·ªôt chu k·ª≥), show reward message + n√∫t nh·∫≠n qu√†
        if (isLong) {
          // Play alert already called above, now show special reward message and button
          overlayTitle.textContent = "üéâ Ch√∫c m·ª´ng ‚Äî Em ƒë·∫°t 4 Pomodoro! üéâ";
          overlayQuote.textContent = randomOf(rewardMessages);
          claimBtn.style.display = "inline-block";
          // nextBtn v·∫´n cho ph√©p ti·∫øp t·ª•c (sang ngh·ªâ d√†i), ho·∫∑c user c√≥ th·ªÉ nh·∫•n "Nh·∫≠n qu√†"
        }
      } else {
        overlayTitle.textContent = "‚è∞ H·∫øt gi·ªù ngh·ªâ r·ªìi em b√© ∆°i";
        overlayQuote.textContent = "C√πng quay l·∫°i h·ªçc ti·∫øp nh√©, anh tin em! üí™‚ú®";
        pendingNextMode = "pomo";
      }
      setTimeLeft(MODES[pendingNextMode]);
      applyModeUI(pendingNextMode);
      refreshAudio();
    }

    function openReward(){
      try { alertSound.pause(); alertSound.currentTime = 0; } catch {}
      window.location.href = "monqua.html";
    }

    function switchMode(m){
      pauseTimer();
      mode = m;
      setTimeLeft(MODES[m]);
      applyModeUI();
      updateTimerUI();
      refreshAudio();
      // Update quote based on mode
      if (m === "pomo") {
        quoteEl.textContent = randomOf(quotesStudy);
      } else if (m === "short") {
        quoteEl.textContent = randomOf(quotesShortBreak);
      } else {
        quoteEl.textContent = randomOf(quotesLongBreak);
      }
    }
    function toggleStart(){
      running ? pauseTimer() : startTimer();
    }
    function startTimer(){
      if (running) return;
      running = true;
      lastTick = Date.now();
      timerId = setInterval(tick, 1000);
      startBtn.textContent = "‚è∏Ô∏è T·∫°m d·ª´ng";
      
      // Hi·ªán c√¢u ƒë·ªông vi√™n khi b·∫Øt ƒë·∫ßu
      if (mode === "pomo") {
        quoteEl.textContent = randomOf(quotesStudy);
      } else if (mode === "short") {
        quoteEl.textContent = randomOf(quotesShortBreak);
      } else {
        quoteEl.textContent = randomOf(quotesLongBreak);
      }
      
      // M·∫∑c ƒë·ªãnh ph√°t playlist "Nh·∫°c h·ªçc b√†i kh√¥ng l·ªùi" khi b·∫Øt ƒë·∫ßu
      activePlaylist = "study"; saveActivePlaylist();
      studyIndex = 0; saveIndex("study.index", studyIndex);
      setLofiEnabled(true);
      playCurrent(true);

      refreshAudio();
    }
    function pauseTimer(){
      if (!running) return;
      running = false;
      clearInterval(timerId);
      timerId = null;
      startBtn.textContent = "‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu";
      if (lofiEnabled) pausePlayer();
      refreshAudio();
    }
    function resetTimer(){
      pauseTimer();
      setTimeLeft(MODES[mode]);
      updateTimerUI();
    }
    function tick(){
      const now = Date.now();
      const delta = Math.max(1, Math.floor((now - lastTick)/1000));
      lastTick = now;
      timeLeft = Math.max(0, timeLeft - delta);

      if (mode === "pomo"){
        stats.totalStudySec += delta;
        if (activeTaskId){
          const t = tasks.find(x => x.id === activeTaskId);
          if (t && !t.done){
            t.minsRemaining = Math.max(0, t.minsRemaining - delta/60);
            if (t.minsRemaining <= 0.0001){
              t.minsRemaining = 0;
              t.done = true;
              activeTaskId = null;
            }
            saveTasks();
            renderTasks();
          }
        }
        saveStats();
      }

      updateTimerUI();
      if (timeLeft <= 0){
        endSession(false);
      }
    }
    function setTimeLeft(s){
      timeLeft = s;
    }
    function applyModeUI(){
      Object.keys(modeBtns).forEach(k => {
        modeBtns[k].classList.toggle("active", k === mode);
        modeBtns[k].setAttribute("aria-selected", k === mode ? "true" : "false");
      });
      document.body.style.background = MODE_BG[mode];
    }
    function updateTimerUI(){
      timerEl.textContent = format(timeLeft);
    }
    function updateStatsUI(){
      pomoCountEl.textContent = stats.totalPomos;
      statMins.textContent = Math.floor(stats.totalStudySec / 60);
      statPomos.textContent = stats.totalPomos;
      statTasks.textContent = tasks.filter(t => t.done).length;
    }
    function updateHearts(){
      const cycle = stats.totalPomos % 4;
      $$("#progress .heart").forEach((h, i) => {
        h.classList.toggle("filled", i < cycle);
      });
    }
    function refreshAudio(){
      try {
        // Khi b·∫≠t playlist, t·∫Øt nh·∫°c study/break ƒë·ªÉ tr√°nh tr√πng
        if (lofiEnabled){
          studyMusic.pause(); breakMusic.pause();
          return;
        }
        studyMusic.pause(); breakMusic.pause();
        if (running){
          if (mode === "pomo") studyMusic.play().catch(()=>{});
          else breakMusic.play().catch(()=>{});
        }
      } catch(e){}
    }

    function renderTasks(){
      taskList.innerHTML = "";
      tasks.forEach(t => {
        const li = document.createElement("li");
        li.className = "task" + (t.done ? " done" : "") + (t.id === activeTaskId && !t.done ? " working" : "");
        const remain = Math.max(0, Math.ceil(t.minsRemaining));
        li.innerHTML = `
          <div class="meta">
            <span class="title">${escapeHtml(t.title)}</span>
            <span>‚Ä¢</span>
            <span>C√≤n ${remain}/${Math.ceil(t.minsTotal)} ph√∫t</span>
          </div>
          <div class="actions">
            <button class="tbtn start" ${t.done ? "disabled" : ""}>Th·ª±c hi·ªán</button>
            <button class="tbtn complete">${t.done ? "ƒê√£ xong" : "Ho√†n th√†nh"}</button>
            <button class="tbtn add">+ ph√∫t</button>
            <!-- TH√äM: n√∫t xo√° -->
            <button class="tbtn reset del">Xo√°</button>
          </div>
        `;
        const [btnStart, btnDone, btnAdd, btnDel] = li.querySelectorAll("button");
        btnStart.addEventListener("click", () => {
          if (t.done) return;
          activeTaskId = t.id;
          saveActiveTask();
          if (mode !== "pomo") switchMode("pomo");
          renderTasks();
          startTimer();
        });
        btnDone.addEventListener("click", () => {
          t.done = true;
          t.minsRemaining = 0;
          if (activeTaskId === t.id) activeTaskId = null;
          saveActiveTask(); saveTasks(); renderTasks(); updateStatsUI();
        });
        btnAdd.addEventListener("click", () => {
          const add = parseInt(prompt("Th√™m bao nhi√™u ph√∫t cho nhi·ªám v·ª• nh·ªâ ?", "5") || "0", 10);
          if (!isNaN(add) && add > 0){
            t.minsTotal += add;
            t.minsRemaining += add;
            if (t.done && t.minsRemaining > 0) t.done = false;
            saveTasks(); renderTasks();
          }
        });
        // TH√äM: x·ª≠ l√Ω xo√° nhi·ªám v·ª•
        btnDel.addEventListener("click", () => {
          if (!confirm("Xo√° nhi·ªám v·ª• n√†y?")) return;
          const idx = tasks.findIndex(x => x.id === t.id);
          if (idx >= 0) tasks.splice(idx, 1);
          if (activeTaskId === t.id) {
            activeTaskId = null;
            saveActiveTask();
          }
          saveTasks();
          renderTasks();
          updateStatsUI();
        });

        taskList.appendChild(li);
      });
      updateStatsUI();
    }

    // Storage helpers
    function loadStats(){
      try { return JSON.parse(localStorage.getItem("study.stats")) || { totalStudySec: 0, totalPomos: 0 }; }
      catch { return { totalStudySec: 0, totalPomos: 0 }; }
    }
    function saveStats(){
      localStorage.setItem("study.stats", JSON.stringify(stats));
    }
    function loadTasks(){
      try { return JSON.parse(localStorage.getItem("study.tasks")) || []; }
      catch { return []; }
    }
    function saveTasks(){
      localStorage.setItem("study.tasks", JSON.stringify(tasks));
    }
    function saveActiveTask(){
      if (activeTaskId) localStorage.setItem("study.activeTaskId", activeTaskId);
      else localStorage.removeItem("study.activeTaskId");
    }

    // Utils
    function format(s){
      const m = Math.floor(s/60).toString().padStart(2,"0");
      const ss = Math.floor(s%60).toString().padStart(2,"0");
      return `${m}:${ss}`;
    }
    function randomOf(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function cryptoId(){ return Math.random().toString(36).slice(2)+Date.now().toString(36); }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
  })();
  </script>
</body>
</html>


